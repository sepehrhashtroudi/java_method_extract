public CrossModuleCodeMotionTest() { [EOL]     super(EXTERNS); [EOL] } <line_num>: 27,29
@Override [EOL] public void setUp() { [EOL]     super.enableLineNumberCheck(true); [EOL] } <line_num>: 31,34
@Override [EOL] public CompilerPass getProcessor(Compiler compiler) { [EOL]     return new CrossModuleCodeMotion(compiler, compiler.getModuleGraph()); [EOL] } <line_num>: 36,39
public void testFunctionMovement1() { [EOL]     JSModule[] modules = createModuleStar("function f1(a) { alert(a); }" + "function f2(a) { alert(a); }" + "function f3(a) { alert(a); }" + "function f4() { alert(1); }" + "function g() { alert('ciao'); }", "f1('hi'); f3('bye'); var a = f4;" + "function h(a) { alert('h:' + a); }", "f2('hi'); f2('hi'); f3('bye');"); [EOL]     test(modules, new String[] { "function f3(a) { alert(a); }" + "function g() { alert('ciao'); }", "function f4() { alert(1); }" + "function f1(a) { alert(a); }" + "f1('hi'); f3('bye'); var a = f4;" + "function h(a) { alert('h:' + a); }", "function f2(a) { alert(a); }" + "f2('hi'); f2('hi'); f3('bye');" }); [EOL] } <line_num>: 41,76
public void testFunctionMovement2() { [EOL]     JSModule[] modules = createModuleStar("function f(a) { alert(a); }" + "function g() {var f = 1; f++}", "f(1);"); [EOL]     test(modules, new String[] { "function g() {var f = 1; f++}", "function f(a) { alert(a); }" + "f(1);" }); [EOL] } <line_num>: 78,94
public void testFunctionMovement3() { [EOL]     JSModule[] modules = createModuleStar("function f(a) { alert(a); }" + "function g(f) {f++}", "f(1);"); [EOL]     test(modules, new String[] { "function g(f) {f++}", "function f(a) { alert(a); }" + "f(1);" }); [EOL] } <line_num>: 96,112
public void testFunctionMovement4() { [EOL]     JSModule[] modules = createModuleStar("function f(){return function(a){}}", "var a = f();"); [EOL]     test(modules, new String[] { "", "function f(){return function(a){}}" + "var a = f();" }); [EOL] } <line_num>: 114,130
public void testFunctionMovement5() { [EOL]     JSModule[] modules = createModuleStar("function f(n){return (n<1)?1:f(n-1)}", "var a = f(4);"); [EOL]     test(modules, new String[] { "", "function f(n){return (n<1)?1:f(n-1)}" + "var a = f(4);" }); [EOL] } <line_num>: 132,148
public void testFunctionMovement5b() { [EOL]     JSModule[] modules = createModuleStar("var f = function(n){return (n<1)?1:f(n-1)};", "var a = f(4);"); [EOL]     test(modules, new String[] { "", "var f = function(n){return (n<1)?1:f(n-1)};" + "var a = f(4);" }); [EOL] } <line_num>: 150,166
public void testFunctionMovement6() { [EOL]     JSModule[] modules = createModuleChain("function f(){return 1}", "var a = f();", "var b = f();"); [EOL]     test(modules, new String[] { "", "function f(){return 1}" + "var a = f();", "var b = f();" }); [EOL] } <line_num>: 168,188
public void testFunctionMovement7() { [EOL]     JSModule[] modules = createModules("function f(){return 1}", "", "var a = f();", "var b = f();", "var c = f();"); [EOL]     modules[1].addDependency(modules[0]); [EOL]     modules[2].addDependency(modules[1]); [EOL]     modules[3].addDependency(modules[1]); [EOL]     modules[4].addDependency(modules[1]); [EOL]     test(modules, new String[] { "", "function f(){return 1}", "var a = f();", "var b = f();", "var c = f();" }); [EOL] } <line_num>: 190,223
public void testFunctionMovement8() { [EOL]     JSModule[] modules = createModuleChain("var v = function f(){return 1}", "v();"); [EOL]     test(modules, new String[] { "", "var v = function f(){return 1};" + "v();" }); [EOL] } <line_num>: 225,241
public void testFunctionNonMovement1() { [EOL]     testSame(createModuleStar("function f(){};f.prototype.bar=new f;" + "if(a)function f2(){}" + "{{while(a)function f3(){}}}", "var a = new f();f2();f3();")); [EOL] } <line_num>: 243,256
public void testFunctionNonMovement2() { [EOL]     testSame(createModuleStar("function f(){return 1}", "var a = f();", "var b = f();")); [EOL] } <line_num>: 258,268
public void testClassMovement1() { [EOL]     test(createModuleStar("function f(){} f.prototype.bar=function (){};", "var a = new f();"), new String[] { "", "function f(){} f.prototype.bar=function (){};" + "var a = new f();" }); [EOL] } <line_num>: 270,281
public void testClassMovement2() { [EOL]     test(createModuleChain("function f(){} f.prototype.bar=3; f.prototype.baz=5;", "f.prototype.baq = 7;", "f.prototype.baz = 9;", "var a = new f();"), new String[] { "", "", "function f(){} f.prototype.bar=3; f.prototype.baz=5;" + "f.prototype.baq = 7;" + "f.prototype.baz = 9;", "var a = new f();" }); [EOL] } <line_num>: 283,306
public void testClassMovement3() { [EOL]     test(createModuleChain("var f = function() {}; f.prototype.bar=3; f.prototype.baz=5;", "f = 7;", "f = 9;", "f = 11;"), new String[] { "", "", "var f = function() {}; f.prototype.bar=3; f.prototype.baz=5;" + "f = 7;" + "f = 9;", "f = 11;" }); [EOL] } <line_num>: 308,331
public void testClassMovement4() { [EOL]     testSame(createModuleStar("function f(){} f.prototype.bar=3; f.prototype.baz=5;", "f.prototype.baq = 7;", "var a = new f();")); [EOL] } <line_num>: 333,341
public void testClassMovement5() { [EOL]     JSModule[] modules = createModules("function f(){} f.prototype.bar=3; f.prototype.baz=5;", "", "f.prototype.baq = 7;", "var a = new f();"); [EOL]     modules[1].addDependency(modules[0]); [EOL]     modules[2].addDependency(modules[1]); [EOL]     modules[3].addDependency(modules[1]); [EOL]     test(modules, new String[] { "", "function f(){} f.prototype.bar=3; f.prototype.baz=5;", "f.prototype.baq = 7;", "var a = new f();" }); [EOL] } <line_num>: 343,369
public void testClassMovement6() { [EOL]     test(createModuleChain("function Foo(){} function Bar(){} goog.inherits(Bar, Foo);" + "new Foo();", "new Bar();"), new String[] { "function Foo(){} new Foo();", "function Bar(){} goog.inherits(Bar, Foo); new Bar();" }); [EOL] } <line_num>: 371,384
public void testClassMovement7() { [EOL]     testSame(createModuleChain("function Foo(){} function Bar(){} goog.inherits(Bar, Foo);" + "new Bar();", "new Foo();")); [EOL] } <line_num>: 386,393
public void testStubMethodMovement1() { [EOL]     test(createModuleChain("function Foo(){} " + "Foo.prototype.bar = JSCompiler_stubMethod(x);", "new Foo();"), new String[] { "", "function Foo(){} " + "Foo.prototype.bar = JSCompiler_stubMethod(x);" + "new Foo();" }); [EOL] } <line_num>: 395,409
public void testStubMethodMovement2() { [EOL]     test(createModuleChain("function Foo(){} " + "Foo.prototype.bar = JSCompiler_unstubMethod(x);", "new Foo();"), new String[] { "", "function Foo(){} " + "Foo.prototype.bar = JSCompiler_unstubMethod(x);" + "new Foo();" }); [EOL] } <line_num>: 411,425
public void testNoMoveSideEffectProperty() { [EOL]     testSame(createModuleChain("function Foo(){} " + "Foo.prototype.bar = createSomething();", "new Foo();")); [EOL] } <line_num>: 427,434
public void testAssignMovement() { [EOL]     test(createModuleChain("var f = 3;" + "f = 5;", "var h = f;"), new String[] { "", "var f = 3;" + "f = 5;" + "var h = f;" }); [EOL]     testSame(createModuleChain("var f = 3;" + "var g = f = 5;", "var h = f;")); [EOL] } <line_num>: 436,459
public void testNoClassMovement2() { [EOL]     test(createModuleChain("var f = {};" + "f.h = 5;", "var h = f;"), new String[] { "", "var f = {};" + "f.h = 5;" + "var h = f;" }); [EOL]     testSame(createModuleChain("var f = {};" + "var g = f.h = 5;", "var h = f;")); [EOL] } <line_num>: 461,484
public void testLiteralMovement1() { [EOL]     test(createModuleChain("var f = {'hi': 'mom', 'bye': function() {}};", "var h = f;"), new String[] { "", "var f = {'hi': 'mom', 'bye': function() {}};" + "var h = f;" }); [EOL] } <line_num>: 486,499
public void testLiteralMovement2() { [EOL]     testSame(createModuleChain("var f = {'hi': 'mom', 'bye': goog.nullFunction};", "var h = f;")); [EOL] } <line_num>: 501,507
public void testLiteralMovement3() { [EOL]     test(createModuleChain("var f = ['hi', function() {}];", "var h = f;"), new String[] { "", "var f = ['hi', function() {}];" + "var h = f;" }); [EOL] } <line_num>: 509,522
public void testLiteralMovement4() { [EOL]     testSame(createModuleChain("var f = ['hi', goog.nullFunction];", "var h = f;")); [EOL] } <line_num>: 524,530
public void testVarMovement1() { [EOL]     JSModule[] modules = createModuleStar("var a = 0;", "var x = a;"); [EOL]     test(modules, new String[] { "", "var a = 0;" + "var x = a;" }); [EOL] } <line_num>: 532,548
public void testVarMovement2() { [EOL]     JSModule[] modules = createModuleStar("var a = 0; var b = 1; var c = 2;", "var x = b;"); [EOL]     test(modules, new String[] { "var a = 0; var c = 2;", "var b = 1;" + "var x = b;" }); [EOL] } <line_num>: 550,566
public void testVarMovement3() { [EOL]     JSModule[] modules = createModuleStar("var a = 0; var b = 1;", "var x = a + b;"); [EOL]     test(modules, new String[] { "", "var b = 1;" + "var a = 0;" + "var x = a + b;" }); [EOL] } <line_num>: 568,585
public void testVarMovement4() { [EOL]     JSModule[] modules = createModuleStar("var a = function(){alert(1)};", "var x = a;"); [EOL]     test(modules, new String[] { "", "var a = function(){alert(1)};" + "var x = a;" }); [EOL] } <line_num>: 588,604
public void testVarMovement5() { [EOL]     testSame(createModuleStar("var a = alert;", "var x = a;")); [EOL] } <line_num>: 607,614
public void testVarMovement6() { [EOL]     JSModule[] modules = createModuleStar("var a;", "var x = a;"); [EOL]     test(modules, new String[] { "", "var a;" + "var x = a;" }); [EOL] } <line_num>: 616,632
public void testVarMovement7() { [EOL]     testSame(createModuleStar("function f() {g();}", "function g(){};")); [EOL] } <line_num>: 634,641
public void testVarMovement8() { [EOL]     JSModule[] modules = createModuleBush("var a = 0;", "", "var x = a;", "var y = a;"); [EOL]     test(modules, new String[] { "", "var a = 0;", "var x = a;", "var y = a;" }); [EOL] } <line_num>: 643,665
public void testVarMovement9() { [EOL]     JSModule[] modules = createModuleTree("var a = 0; var b = 1; var c = 3;", "", "", "a;", "a;c;", "b;", "b;c;"); [EOL]     test(modules, new String[] { "var c = 3;", "var a = 0;", "var b = 1;", "a;", "a;c;", "b;", "b;c;" }); [EOL] } <line_num>: 667,701
public void testClone1() { [EOL]     test(createModuleChain("function f(){} f.prototype.clone = function() { return new f };", "var a = (new f).clone();"), new String[] { "", "function f(){} f.prototype.clone = function() { return new f() };" + "var a = (new f).clone();" }); [EOL] } <line_num>: 703,716
public void testClone2() { [EOL]     test(createModuleChain("function f(){}" + "f.prototype.cloneFun = function() {" + "  return function() {new f}" + "};", "var a = (new f).cloneFun();"), new String[] { "", "function f(){}" + "f.prototype.cloneFun = function() {" + "  return function() {new f}" + "};" + "var a = (new f).cloneFun();" }); [EOL] } <line_num>: 718,737
public void testBug4118005() { [EOL]     testSame(createModuleChain("var m = 1;\n" + "(function () {\n" + " var x = 1;\n" + " m = function() { return x };\n" + "})();\n", "m();")); [EOL] } <line_num>: 739,749
public void testEmptyModule() { [EOL]     JSModule m1 = new JSModule("m1"); [EOL]     m1.add(SourceFile.fromCode("m1", "function x() {}")); [EOL]     JSModule empty = new JSModule("empty"); [EOL]     empty.addDependency(m1); [EOL]     JSModule m2 = new JSModule("m2"); [EOL]     m2.add(SourceFile.fromCode("m2", "x()")); [EOL]     m2.addDependency(empty); [EOL]     JSModule m3 = new JSModule("m3"); [EOL]     m3.add(SourceFile.fromCode("m3", "x()")); [EOL]     m3.addDependency(empty); [EOL]     test(new JSModule[] { m1, empty, m2, m3 }, new String[] { "", "function x() {}", "x()", "x()" }); [EOL] } <line_num>: 751,779
